# 📘 AI日記リフレクションBot（MVP）仕様書(v2)

## 🎯 目的・コンセプト

ユーザーが LINE 上で日記を書くだけで、AI が感情や主題、傾向を分析・要約し、
自己理解・自己受容・内省習慣の定着をサポートする AI 日記 Bot。

---

## 🏗️ システム構成と使用技術

| 機能/役割          | 技術                      | 補足                                               |
| ------------------ | ------------------------- | -------------------------------------------------- |
| UI                 | LINE Messaging API        | 日記入力＆AI分析結果をやり取りする主インタフェース |
| Botサーバー        | Cloudflare Workers + Hono | 軽量・高速、エッジ実行環境、Express風に書ける      |
| AI分析             | OpenAI GPT-3.5-turbo      | 日記と履歴要約をもとに感情・主題・傾向を出力       |
| DB                 | Cloudflare D1             | SQLiteベースのサーバーレスDB、エッジで高速動作     |
| Secrets管理        | Cloudflareの環境変数      | OpenAIキーやLINEトークンを安全に保管               |
| 認証               | LINE userId + 署名検証    | 外部認証不要、LINEの署名で正当性を担保             |
| バッチ処理         | Scheduled Workers         | 定期クリーンアップ・キャッシュ更新・最適化         |
| エラーハンドリング | 包括的エラー管理システム  | リトライ・サーキットブレーカー・分類機能           |

---

## ✍️ 主な機能

### 📥 ユーザー入力

- ユーザーが LINE で自由形式の日記を送信
- **ローディングアニメーション表示**（最大5秒、軽量分析用に最適化）

### 📤 非同期AI分析フロー（２段階処理）

#### 第1段階：即座応答 (diary-handler)

1. **署名検証** - LINE Webhook署名の検証によるセキュリティ確保
2. **ローディング表示** - 5秒間のアニメーション表示
3. **日記保存** - 日記内容をDBに保存
4. **「分析中」返信** - replyMessageで即座に分析中メッセージを送信

#### 第2段階：非同期分析 (async-ai-analysis)

5. **履歴要約取得** - 直近7日間の履歴要約をキャッシュから取得（タイムアウト5秒）
6. **AI分析実行** - 当日日記 + 履歴要約をGPT-3.5-turboに送信
7. **結果保存** - 分析結果をDBに保存
8. **結果送信** - pushMessageで詳細分析結果を送信
9. **エラー処理** - 各段階でのエラーハンドリングとwaitUntil機構

---

## 🔥 実装済み高度機能

### 🎪 LINE Messaging API ローディングアニメーション

- **機能**: 分析処理中のローディングアニメーション表示（最大5秒）
- **実装場所**: `src/services/line/message.ts:38-47`
- **フォールバック**: アニメーション表示失敗時もメイン処理は継続

### 🛡️ 包括的エラーハンドリングシステム

- **エラー分類**: 一時的/永続的/レート制限/ネットワーク/バリデーション/不明
- **リトライ機能**: 指数バックオフによるインテリジェントリトライ
- **サーキットブレーカー**: 連続失敗時の自動保護機能
- **実装場所**: `src/utils/error-handler.ts`
- **カテゴリ別対応**:
  - OpenAI APIエラー: レート制限認識・自動リトライ
  - データベースエラー: 接続エラー・タイムアウト対策
  - LINE APIエラー: ステータスコード別分類

### ⚡ バッチ処理による最適化機能

- **定期実行**: 1日1回（午前2時 UTC）のスケジュール実行
- **機能一覧**:
  - 要約キャッシュの定期更新
  - 古いデータの自動クリーンアップ（90日超のエントリー、30日超のサマリー）
  - API使用量最適化（重複サマリー削除、未使用キャッシュ削除）
  - 使用量モニタリング・アラート機能
- **実装場所**: `src/handlers/scheduled.ts`
- **バッチサイズ**: 50ユーザー/バッチ、100ms間隔

### 🏃‍♂️ レースコンディション対策

- **機能**: 要約生成時の重複処理防止
- **実装方式**: 進行中リクエストのMap管理
- **対象**: HistorySummaryService における並行要約生成制御
- **実装場所**: `src/services/summary.ts:48-51, 86-95`

---

## 📦 履歴要約の仕様

| 項目               | 内容                                                         |
| ------------------ | ------------------------------------------------------------ |
| 対象期間           | 過去7日分の投稿                                              |
| 内容               | 感情傾向・テーマ・変化などの要約（自然文または構造化）       |
| キャッシュ保存     | userId + 日付範囲 + 要約をDBに保存（キャッシュとして再利用） |
| トークン最適化     | 過去の全文ではなく要約のみをGPTに渡すことで軽量化            |
| **キャッシュ期間** | **24時間（環境変数CACHE_DURATION_HOURSで設定可能）**         |
| **最小投稿数**     | **2件以上の投稿で要約生成**                                  |
| **文字数制限**     | **1エントリーあたり500文字まで（GPTトークン最適化）**        |

## 💻 開発・テスト用機能
- **バッチ処理テスト**: `/dev/run-batch` エンドポイントでローカル検証可能
- **テストコマンド**: `pnpm run batch:test` で簡単実行
- **開発手順書**: `scripts/test-batch.md` に詳細手順を記録

## 🎆 未使用機能の削除最適化
- **テスト用エンドポイント削除**: `/test-db`, `/test-openai` は本番環境から除去
- **パフォーマンスモニター削除**: メトリクス関連機能を全面的に削除
- **コードサイズ最適化**: 未使用の型定義やexportを内部型に変更

---

## 🔐 認証とセキュリティ設計

| 項目               | 内容                                               |
| ------------------ | -------------------------------------------------- |
| ユーザー識別       | LINEの `userId` を使用（一意な識別子）             |
| リクエスト検証     | `X-Line-Signature` ヘッダーによるHMAC署名検証      |
| セッション管理     | なし（LINE側で完結）                               |
| データ管理         | 各レコードに `userId` を保持し、ユーザーごとに制御 |
| **環境変数管理**   | **Cloudflare Secrets による機密情報の安全な管理**  |
| **エラー情報保護** | **技術的詳細を隠蔽し、適切なユーザーメッセージ**   |
| **入力値検証**     | **全外部入力に対するバリデーション実装**           |

---

## 📁 データベース設計（概要）

### テーブル一覧

| テーブル名  | 役割                       | 主要カラム                                                                 |
| ----------- | -------------------------- | -------------------------------------------------------------------------- |
| `entries`   | ユーザーが投稿した日記本文 | id, user_id, content, created_at, updated_at                               |
| `analyses`  | 各投稿に対するGPT分析結果  | id, entry_id, user_id, emotion, themes, patterns, positive_points          |
| `summaries` | 過去7日間の要約キャッシュ  | id, user_id, start_date, end_date, summary_content, created_at, updated_at |

### インデックス設計

- `idx_entries_user_id` - ユーザー別エントリー検索最適化
- `idx_entries_created_at` - 時系列検索最適化
- `idx_summaries_dates` - 日付範囲検索最適化
- **外部キー制約**: entries削除時のanalyses自動削除（CASCADE）

※ 全テーブルに `userId` を持たせてデータ分離を実現

---

## 🧠 GPTプロンプト構成

### 日記分析プロンプト

```text
あなたは優秀な日記分析AIです。ユーザーの日記から感情や思考を理解し、
温かく建設的なフィードバックを提供します。

【過去7日間の傾向】
{summary_cache}

【本日の投稿】
{diary_content}

以下を出力してください：
1. 現在の感情と過去からの変化
2. 主なテーマや思考パターン
3. ポジティブな点・励ましのコメント
```

### 履歴要約プロンプト

```text
あなたは日記要約の専門家です。過去7日間の日記投稿を分析し、
感情傾向・主要テーマ・思考パターン・成長ポイントを150文字程度で簡潔に要約してください。

要約には以下の要素を含めてください：
- 主な感情傾向（ポジティブ/ネガティブ/変化）
- 繰り返し言及されるテーマや関心事
- 行動パターンや思考の特徴
- 成長や変化の兆し
```
