# 📘 AI日記リフレクションBot（MVP）仕様書(v1)

## 🎯 目的・コンセプト

ユーザーが LINE 上で日記を書くだけで、AI が感情や主題、傾向を分析・要約し、
自己理解・自己受容・内省習慣の定着をサポートする AI 日記 Bot。

---

## 🏗️ システム構成と使用技術

| 機能/役割       | 技術                           | 補足                                           |
|----------------|--------------------------------|------------------------------------------------|
| UI             | LINE Messaging API             | 日記入力＆AI分析結果をやり取りする主インタフェース |
| Botサーバー    | Cloudflare Workers + Hono      | 軽量・高速、エッジ実行環境、Express風に書ける     |
| AI分析         | OpenAI GPT（Chat API）         | 日記と履歴要約をもとに感情・主題・傾向を出力       |
| DB             | Cloudflare D1                  | SQLiteベースのサーバーレスDB、エッジで高速動作     |
| Secrets管理    | Cloudflareの環境変数            | OpenAIキーやLINEトークンを安全に保管              |
| 認証           | LINE userId + 署名検証         | 外部認証不要、LINEの署名で正当性を担保            |

---

## ✍️ 主な機能

### 📥 ユーザー入力

- ユーザーが LINE で自由形式の日記を送信

### 📤 AI分析フロー（1投稿ごと）

1. 日記内容をDBに保存
2. DBから直近7日間の履歴要約をキャッシュから取得
3. 当日日記 + 履歴要約をGPTに送信
4. GPTが感情・主題・傾向・ポジティブ点を出力
5. 結果をLINEへ返信・DBに保存

---

## 📦 履歴要約の仕様

| 項目          | 内容                                                                 |
|---------------|----------------------------------------------------------------------|
| 対象期間      | 過去7日分の投稿                                                     |
| 内容          | 感情傾向・テーマ・変化などの要約（自然文または構造化）              |
| キャッシュ保存 | userId + 日付範囲 + 要約をDBに保存（キャッシュとして再利用）         |
| トークン最適化 | 過去の全文ではなく要約のみをGPTに渡すことで軽量化                    |

---

## 🔐 認証とセキュリティ設計

| 項目             | 内容                                                |
|------------------|-----------------------------------------------------|
| ユーザー識別     | LINEの `userId` を使用（一意な識別子）              |
| リクエスト検証   | `X-Line-Signature` ヘッダーによるHMAC署名検証       |
| セッション管理   | なし（LINE側で完結）                                 |
| データ管理       | 各レコードに `userId` を保持し、ユーザーごとに制御   |

---

## 📁 データベース設計（概要）

### テーブル一覧

| テーブル名     | 役割                       |
|----------------|----------------------------|
| `entries`      | ユーザーが投稿した日記本文 |
| `analyses`     | 各投稿に対するGPT分析結果  |
| `summaries`    | 過去7日間の要約キャッシュ  |

※ 全テーブルに `userId` を持たせる

---

## 🧠 GPTプロンプト構成（例）

```text
あなたはユーザーの日記を分析するAIです。

【過去7日間の傾向】
{summary_cache}

【本日の投稿】
「今日は〇〇な気持ちになった。△△があった。」

以下を出力してください：
1. 現在の感情と過去からの変化
2. 主なテーマや思考パターン
3. ポジティブな点・励ましのコメント
